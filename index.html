<script>
  // ---------- Utility helpers ----------
  const $ = (sel) => document.querySelector(sel);
  const $$ = (sel) => Array.from(document.querySelectorAll(sel));
  const getParam = (k) => new URLSearchParams(location.search).get(k);
  const fmtTime = (ts) => new Date(ts).toLocaleString();
  const uid = () => Math.random().toString(36).slice(2)+Date.now().toString(36);

  const CONFIG_KEY = 'ecard_fb_config_v1';
  const LOCAL_KEY  = 'ecard_local_posts_v1';

  // Load stored Firebase config (if any)
  function loadConfig(){
    try{ return JSON.parse(localStorage.getItem(CONFIG_KEY)||'{}'); }catch(e){ return {}; }
  }
  function saveConfig(obj){ localStorage.setItem(CONFIG_KEY, JSON.stringify(obj||{})); }

  // Resize image to max width 1600px for lighter uploads
  function resizeImage(file, maxW=1600){
    return new Promise((resolve)=>{
      const img = new Image();
      const url = URL.createObjectURL(file);
      img.onload = ()=>{
        const scale = Math.min(1, maxW/img.width);
        const canvas = document.createElement('canvas');
        canvas.width  = Math.round(img.width*scale);
        canvas.height = Math.round(img.height*scale);
        const ctx = canvas.getContext('2d');
        ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
        canvas.toBlob(b=>{ URL.revokeObjectURL(url); resolve(b||file); }, 'image/jpeg', 0.88);
      };
      img.src = url;
    });
  }

  // ---------- Mode detection (Local vs Firebase) ----------
  let app=null, db=null, storage=null, auth=null, mode='local';
  const cfg = loadConfig();
  const looksConfigured = cfg && cfg.apiKey && !String(cfg.apiKey).includes('PASTE_YOUR_FIREBASE_API_KEY_HERE');

  if(looksConfigured){
    try{
      app = firebase.initializeApp(cfg);
      db = firebase.firestore();
      storage = firebase.storage();
      auth = firebase.auth();
      mode='cloud';
      $('#modeLabel').textContent='Shared (Firebase)';
      $('#storageNotice').classList.add('hide');
      $('#clearLocal').classList.add('hide');
    }catch(e){
      console.warn('Firebase init failed, falling back to local mode', e);
      mode='local';
      $('#modeLabel').textContent='Local demo';
    }
  } else {
    mode='local';
    $('#modeLabel').textContent='Local demo';
  }

  // ---------- Rendering ----------
  function escapeHtml(str){
    return String(str)
      .replace(/&/g,'&amp;')
      .replace(/</g,'&lt;')
      .replace(/>/g,'&gt;')
      .replace(/"/g,'&quot;')
      .replace(/'/g,'&#39;')
      .replace(/\//g,'&#47;');
  }

  function render(posts){
    const grid = $('#grid');
    const empty = $('#emptyState');
    grid.innerHTML='';
    if(!posts || posts.length===0){
      empty.style.display='block';
      $('#countPill').textContent='0 posts';
      return;
    }
    empty.style.display='none';
    $('#countPill').textContent = posts.length + (posts.length===1?' post':' posts');
    posts.forEach(p=>{
      const card = document.createElement('article');
      card.className='msg';
      let mediaHTML='';
      (p.photos||[]).slice(0,1).forEach(url=>{ mediaHTML+=`<img class="media" alt="photo" loading="lazy" src="${url}"/>`; });
      card.innerHTML = `
        ${mediaHTML}
        <div class="body">
          <div class="name">${(p.name||'Anonymous')}</div>
          <div style="margin:6px 0 8px;white-space:pre-wrap">${escapeHtml(p.message||'')}</div>
          <div class="time">${fmtTime(p.createdAt||Date.now())}</div>
        </div>`;
      grid.appendChild(card);
    });
  }

  // ---------- Data layer ----------
  let unsubscribe = null;

  async function listPosts(){
    if(mode==='cloud'){
      const snap = await db.collection('messages').orderBy('createdAt','desc').limit(200).get();
      return snap.docs.map(d=>({id:d.id, ...d.data()}));
    } else {
      try{ return JSON.parse(localStorage.getItem(LOCAL_KEY)||'[]'); } catch(e){ return []; }
    }
  }

  function subscribePosts(){
    if(mode!=='cloud') return;
    if(unsubscribe) unsubscribe();
    unsubscribe = db.collection('messages').orderBy('createdAt','desc').limit(200)
      .onSnapshot((snap)=>{
        const posts = snap.docs.map(d=>({id:d.id, ...d.data()}));
        render(posts);
      });
  }

  async function addPost({name,message,files}){
    const createdAt = Date.now();
    let photos=[];

    // Pre-process files (max 3)
    const selected = Array.from(files||[]).slice(0,3);

    if(mode==='cloud'){
      await auth.signInAnonymously().catch(()=>{});
      for(const f of selected){
        const blob = await resizeImage(f);
        const ref  = storage.ref().child(`uploads/${createdAt}_${uid()}.jpg`);
        await ref.put(blob);
        const url = await ref.getDownloadURL();
        photos.push(url);
      }
      const doc = {name:name||'Anonymous', message, photos, createdAt};
      const res = await db.collection('messages').add(doc);
      return {id:res.id, ...doc};
    } else {
      for(const f of selected){
        const blob = await resizeImage(f);
        const b64  = await blobToDataURL(blob);
        photos.push(b64);
      }
      const post = {id:uid(), name:name||'Anonymous', message, photos, createdAt};
      const arr  = await listPosts();
      arr.unshift(post);
      localStorage.setItem(LOCAL_KEY, JSON.stringify(arr));
      return post;
    }
  }

  function blobToDataURL(blob){
    return new Promise((resolve)=>{
      const fr = new FileReader();
      fr.onload = ()=>resolve(fr.result);
      fr.readAsDataURL(blob);
    });
  }

  // ---------- QR tools ----------
  async function showQR(){
    const url = window.location.href;
    const canvas = $('#qrCanvas');
    await QRCode.toCanvas(canvas, url, {margin:1, width:256});
    $('#qrModal').showModal();
  }

  function downloadCanvasPNG(canvas, filename){
    const a = document.createElement('a');
    a.download = filename;
    a.href = canvas.toDataURL('image/png');
    a.click();
  }

  // ---------- Event wiring ----------
  document.addEventListener('DOMContentLoaded', async ()=>{
    // View-only mode via ?view=1
    const isViewOnly = getParam('view');
    if(isViewOnly){
      $('#inputSection').style.display='none';
      $('#adminSection') && ($('#adminSection').style.display='none');
    }

    // Initial load
    if(mode==='cloud'){ subscribePosts(); } else { render(await listPosts()); }

    // Character countdown
    const messageEl = $('#message');
    const charLeft  = $('#charLeft');
    if(messageEl){
      messageEl.addEventListener('input', ()=>{ charLeft.textContent = 800 - messageEl.value.length; });
    }

    // Form submit
    const form = $('#postForm');
    if(form){
      form.addEventListener('submit', async (e)=>{
        e.preventDefault();
        const name = $('#name').value.trim();
        const message = $('#message').value.trim();
        const files = $('#photos').files;
        if(!message){ alert('Please write a message.'); return; }
        for (const f of files){ if(f.size > 4*1024*1024){ alert('Each image must be under 4 MB.'); return; } }
        const btn = e.submitter; const prev = btn.textContent; btn.disabled=true; btn.textContent='Uploading…';
        try{
          await addPost({name,message,files});
          form.reset();
          if(charLeft) charLeft.textContent = 800;
          const posts = await listPosts();
          render(posts);
          document.getElementById('grid').scrollIntoView({behavior:'smooth'});
        }catch(err){ console.error(err); alert('Sorry, something went wrong.'); }
        finally{ btn.disabled=false; btn.textContent=prev; }
      });
    }

    // Share link
    $('#shareBtn').addEventListener('click', async ()=>{
      const url = window.location.href;
      if(navigator.share){ try{ await navigator.share({title:document.title, url}); } catch(_){} }
      try{ await navigator.clipboard.writeText(url); $('#shareBtn').textContent='✅ Link copied!'; setTimeout(()=> $('#shareBtn').textContent='🔗 Share Link', 1500);}catch(_){ prompt('Copy this link:', url); }
    });

    // Print / Save PDF
    $('#printBtn').addEventListener('click', ()=> window.print());

    // View-only link
    $('#viewOnlyBtn').addEventListener('click', async ()=>{
      const url = new URL(location.href);
      url.searchParams.set('view','1');
      try{
        await navigator.clipboard.writeText(url.toString());
        $('#viewOnlyBtn').textContent='✅ View-Only Copied';
        setTimeout(()=> $('#viewOnlyBtn').textContent='👀 Copy View-Only Link',1500);
      }catch(_){ prompt('Copy this link:', url.toString()); }
    });

    // QR modal
    $('#qrBtn').addEventListener('click', showQR);
    $('#closeQR').addEventListener('click', ()=> $('#qrModal').close());
    $('#dlQR').addEventListener('click', ()=> downloadCanvasPNG($('#qrCanvas'), 'ecard-qr.png'));

    // Slideshow
    let slideIndex = 0, slideTimer=null, slidePosts=[];
    function stage(post){
      const stage = $('#slideStage');
      stage.innerHTML='';
      const hasPhoto = (post.photos||[]).length>0;
      if(hasPhoto){
        const img = new Image(); img.alt='slide image'; img.loading='eager'; img.style.maxWidth='100%'; img.style.maxHeight='68vh'; img.style.objectFit='contain';
        img.src = post.photos[0]; stage.appendChild(img);
      } else {
        const div = document.createElement('div');
        div.style.padding='40px'; div.style.textAlign='center';
        div.innerHTML = `<div style="font-size:22px;font-weight:800;margin-bottom:6px">${post.name||'Anonymous'}</div>
                         <div style="white-space:pre-wrap;font-size:18px;opacity:.9">${escapeHtml(post.message||'')}</div>`;
        stage.appendChild(div);
      }
      $('#slideCaption').innerHTML = `<strong>${post.name||'Anonymous'}</strong> • ${fmtTime(post.createdAt)}`;
    }
    function show(i){ if(slidePosts.length===0) return; slideIndex = (i+slidePosts.length)%slidePosts.length; stage(slidePosts[slideIndex]); }
    function startAuto(){ if(slideTimer) return; slideTimer=setInterval(()=>show(slideIndex+1), 4000); $('#playPause').textContent='⏸ Stop'; }
    function stopAuto(){ clearInterval(slideTimer); slideTimer=null; $('#playPause').textContent='▶︎ Auto'; }

    async function openSlideshow(){
      slidePosts = await listPosts();
      if(slidePosts.length===0){ alert('No posts yet.'); return; }
      show(0);
      $('#slideModal').showModal();
      startAuto();
    }

    $('#slideBtn').addEventListener('click', openSlideshow);
    $('#closeSlide').addEventListener('click', ()=>{ stopAuto(); $('#slideModal').close(); });
    $('#nextSlide').addEventListener('click', ()=> show(slideIndex+1));
    $('#prevSlide').addEventListener('click', ()=> show(slideIndex-1));
    $('#playPause').addEventListener('click', ()=> slideTimer?stopAuto():startAuto());
    document.addEventListener('keydown', (e)=>{
      if(!$('#slideModal').open) return;
      if(e.key==='ArrowRight') show(slideIndex+1);
      if(e.key==='ArrowLeft') show(slideIndex-1);
      if(e.key===' ') { e.preventDefault(); slideTimer?stopAuto():startAuto(); }
      if(e.key==='Escape'){ stopAuto(); $('#slideModal').close(); }
    });

    // Auto start slideshow if ?slideshow=1
    if(getParam('slideshow')){ openSlideshow(); }

    // Export
    function toCSV(arr){
      const esc = (s)=> '"'+String(s||'').replace(/"/g,'""')+'"';
      const rows = [['name','message','photo1','photo2','photo3','createdAtISO']]
        .concat(arr.map(p=>[
          p.name||'Anonymous', p.message||'', (p.photos||[])[0]||'', (p.photos||[])[1]||'', (p.photos||[])[2]||'', new Date(p.createdAt||Date.now()).toISOString()
        ]));
      return rows.map(r=>r.map(esc).join(',')).join('\n');
    }
    function download(name, mime, text){
      const blob = new Blob([text], {type:mime});
      const a = document.createElement('a');
      a.href = URL.createObjectURL(blob); a.download = name; a.click();
      setTimeout(()=> URL.revokeObjectURL(a.href), 1000);
    }
    $('#exportBtn').addEventListener('click', async ()=>{
      const posts = await listPosts();
      if(posts.length===0){ alert('No posts to export yet.'); return; }
      download('guestbook.json','application/json', JSON.stringify(posts, null, 2));
      download('guestbook.csv','text/csv', toCSV(posts));
    });

    // Config save/reset
    $('#saveCfg').addEventListener('click', ()=>{
      try{
        const val = JSON.parse($('#fbConfig').value||'{}');
        saveConfig(val); location.reload();
      }catch(_){ alert('Config must be valid JSON.'); }
    });
    $('#resetCfg').addEventListener('click', ()=>{ saveConfig({}); location.reload(); });

    // Clear local demo data
    $('#clearLocal').addEventListener('click', ()=>{
      if(confirm('Clear all locally stored posts on this device?')){
        localStorage.removeItem(LOCAL_KEY); render([]);
      }
    });
  });
</script>
